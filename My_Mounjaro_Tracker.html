<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Mounjaro Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #d4e5d0 0%, #b8cdb5 100%); min-height: 100vh; padding: 1rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        .setup-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .setup-card { background: white; border-radius: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.15); padding: 2rem; max-width: 28rem; width: 100%; }
        .setup-icon { text-align: center; font-size: 4rem; margin-bottom: 1rem; }
        .setup-title { text-align: center; font-size: 2rem; font-weight: bold; color: #333; margin-bottom: 0.5rem; }
        .setup-subtitle { text-align: center; color: #666; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 600; color: #333; margin-bottom: 0.5rem; }
        .form-input { width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 0.5rem; font-size: 1rem; }
        .form-input:focus { outline: none; border-color: #6b8e6b; }
        .btn { width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #a8b5a0 0%, #8fa287 100%); color: black; font-weight: 700; }
        .btn-primary:hover { box-shadow: 0 10px 25px rgba(107, 142, 107, 0.3); }
        .btn-secondary { background: #e5e7eb; color: #333; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn-danger { background: #fee2e2; color: #dc2626; font-size: 0.875rem; margin-top: 1rem; }
        .btn-danger:hover { background: #fecaca; }
        .btn-export { background: #6b8e6b; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; }
        .btn-export:hover { background: #5a7a5a; }
        .header { background: linear-gradient(135deg, #a8b5a0 0%, #8fa287 100%); border-radius: 1rem 1rem 0 0; padding: 1.5rem; color: white; position: relative; }
        .settings-btn { position: absolute; top: 1rem; right: 1rem; background: rgba(0,0,0,0.1); border: none; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; font-size: 1.25rem; color: white; }
        .settings-btn:hover { background: rgba(0,0,0,0.2); }
        .user-name { font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem; color: white; }
        .app-title { font-size: 1.875rem; font-weight: bold; margin-bottom: 0.5rem; color: white; }
        .affirmation { font-size: 0.875rem; font-style: italic; color: #4a6b4a; text-align: center; padding: 1rem; background: #e8f0e6; border-radius: 0.5rem; margin-top: 1rem; font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem; }
        .stat-card { background: rgba(0,0,0,0.1); border-radius: 0.5rem; padding: 0.75rem; }
        .stat-label { font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem; font-weight: 600; color: white; }
        .stat-value { font-size: 1.25rem; font-weight: bold; color: white; }
        .stat-value.green { color: white; }
        .stat-value.yellow { color: white; }
        .progress-bar-container { background: rgba(0,0,0,0.2); border-radius: 1rem; height: 1.5rem; margin-top: 0.5rem; overflow: hidden; }
        .progress-bar-fill { background: linear-gradient(90deg, #4ade80, #22c55e); height: 100%; transition: width 0.5s ease; border-radius: 1rem; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; color: white; }
        .tabs { background: white; display: flex; border-bottom: 1px solid #e5e7eb; overflow-x: auto; }
        .tab { flex: 0 0 auto; padding: 1rem; font-weight: 600; border: none; background: none; cursor: pointer; color: #6b7280; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab.active { color: #6b8e6b; border-bottom-color: #6b8e6b; }
        .content { background: white; border-radius: 0 0 1rem 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.15); padding: 1.5rem; min-height: 250px; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
        .content-title { font-size: 1.25rem; font-weight: bold; color: #333; }
        .btn-add { background: #6b8e6b; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .btn-add:hover { background: #5a7a5a; }
        .form-card { background: #e8f0e6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .form-card-title { font-weight: 600; color: #4a6b4a; margin-bottom: 0.75rem; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .form-grid-full { grid-column: span 2; }
        .form-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
        table { width: 100%; border-collapse: collapse; }
        thead tr { background: linear-gradient(135deg, #a8b5a0 0%, #8fa287 100%); color: black; }
        th { padding: 1rem; text-align: left; font-weight: 700; font-size: 0.875rem; }
        th.center { text-align: center; }
        tbody tr { transition: background 0.3s; }
        tbody tr:nth-child(even) { background: #e8f0e6; }
        tbody tr:hover { background: #d4e5d0; }
        td { padding: 1rem; font-size: 0.875rem; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 600; }
        .badge-purple { background: #d4e5d0; color: #4a6b4a; }
        .badge-red { background: #fecaca; color: #dc2626; }
        .badge-green { background: #bbf7d0; color: #16a34a; }
        .badge-blue { background: #dbeafe; color: #2563eb; }
        .weight-large { font-weight: bold; font-size: 1.125rem; color: #333; }
        .actions { display: flex; gap: 0.5rem; justify-content: center; }
        .btn-icon { border: none; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 1rem; }
        .btn-edit { background: #dbeafe; color: #2563eb; }
        .btn-edit:hover { background: #bfdbfe; }
        .btn-delete { background: #fee2e2; color: #dc2626; }
        .btn-delete:hover { background: #fecaca; }
        .empty-state { text-align: center; padding: 3rem; color: #6b7280; }
        .summary-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 1rem; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal { background: white; border-radius: 1rem; padding: 2rem; max-width: 28rem; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; }
        .modal-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
        .modal-actions .btn { flex: 1; }
        #customDoseContainer { display: none; }
        .chart-container { background: #f8f9fa; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        canvas { max-height: 300px; }
        .water-tracker { display: flex; align-items: center; gap: 1rem; background: #e8f0e6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .water-counter { display: flex; align-items: center; gap: 0.5rem; }
        .water-btn { background: #6b8e6b; color: white; border: none; width: 2.5rem; height: 2.5rem; border-radius: 50%; font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .water-btn:hover { background: #5a7a5a; }
        .water-display { font-size: 1.5rem; font-weight: bold; color: #4a6b4a; min-width: 4rem; text-align: center; }
        .side-effects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; margin: 1rem 0; }
        .side-effect-btn { padding: 0.5rem; border: 2px solid #ddd; border-radius: 0.5rem; background: white; cursor: pointer; text-align: center; font-size: 0.875rem; transition: all 0.2s; }
        .side-effect-btn.active { background: #fee2e2; border-color: #dc2626; color: #dc2626; font-weight: 600; }
        .side-effect-btn:hover { border-color: #6b8e6b; }
        .daily-log-card { background: white; border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
        .daily-log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .daily-log-date { font-weight: bold; color: #4a6b4a; }
        .daily-log-content { color: #666; font-size: 0.875rem; }
        .chart-type-selector { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .chart-type-btn { padding: 0.5rem 1rem; border: 2px solid #ddd; border-radius: 0.5rem; background: white; cursor: pointer; font-size: 0.875rem; }
        .chart-type-btn.active { background: #6b8e6b; color: white; border-color: #6b8e6b; }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .form-grid { grid-template-columns: 1fr; }
            .side-effects-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let profile = JSON.parse(localStorage.getItem('mounjaro_profile')) || { name: '', startingWeight: 0, startDate: '', desiredWeight: 0, measurementUnit: 'cm', isSetup: false };
        let weightEntries = JSON.parse(localStorage.getItem('mounjaro_weights')) || [];
        let measurements = JSON.parse(localStorage.getItem('mounjaro_measurements')) || [];
        let customMeasurements = JSON.parse(localStorage.getItem('mounjaro_custom_measurements')) || [];
        let dailyLogs = JSON.parse(localStorage.getItem('mounjaro_daily_logs')) || [];
        let activeTab = 'weight';
        let editingWeightIndex = null;
        let editingMeasurementIndex = null;
        let weightChart = null;
        let measurementChart = null;
        let selectedMeasurementChart = 'chest';

        const affirmations = [
            "Every small step is progress",
            "You are stronger than you think",
            "Trust the process, trust yourself",
            "Progress, not perfection",
            "Your journey is uniquely yours",
            "Celebrate every victory",
            "You've got this!",
            "One day at a time",
            "Be proud of how far you've come",
            "Your health is worth it",
            "Consistency creates change",
            "You are worth the effort",
            "Small changes, big results",
            "Keep going, you're doing great",
            "Every choice matters"
        ];

        const commonSideEffects = [
            'Nausea', 'Fatigue', 'Headache', 'Diarrhea', 
            'Constipation', 'Vomiting', 'Dizziness', 'Stomach Pain',
            'Decreased Appetite', 'Heartburn', 'Bloating', 'Other'
        ];

        function getRandomAffirmation() {
            return affirmations[Math.floor(Math.random() * affirmations.length)];
        }

        function formatDate(d) {
            if (!d) return '';
            const [y, m, day] = d.split('-');
            return day + '/' + m + '/' + y.slice(2);
        }

        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function getTodayLog() {
            const today = getTodayDate();
            return dailyLogs.find(log => log.date === today) || null;
        }

        function createOrUpdateTodayLog(updates) {
            const today = getTodayDate();
            const existingIndex = dailyLogs.findIndex(log => log.date === today);
            
            if (existingIndex >= 0) {
                dailyLogs[existingIndex] = { ...dailyLogs[existingIndex], ...updates };
            } else {
                dailyLogs.push({ date: today, water: 0, meals: '', sideEffects: [], ...updates });
            }
            saveData();
        }

        function saveData() {
            localStorage.setItem('mounjaro_profile', JSON.stringify(profile));
            localStorage.setItem('mounjaro_weights', JSON.stringify(weightEntries));
            localStorage.setItem('mounjaro_measurements', JSON.stringify(measurements));
            localStorage.setItem('mounjaro_custom_measurements', JSON.stringify(customMeasurements));
            localStorage.setItem('mounjaro_daily_logs', JSON.stringify(dailyLogs));
        }

        function exportData() {
            const data = {
                profile: profile,
                weightEntries: weightEntries,
                measurements: measurements,
                customMeasurements: customMeasurements,
                dailyLogs: dailyLogs,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'mounjaro_tracker_backup_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportToCSV() {
            if (weightEntries.length === 0) {
                alert('No data to export');
                return;
            }
            
            let csv = 'Date,Weight (kg),Dose (mg),Notes\n';
            weightEntries.forEach(entry => {
                csv += `${entry.date},${entry.weight},${entry.dose},"${(entry.notes || '').replace(/"/g, '""')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'mounjaro_weight_data_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            URL.revokeObjectURL(url);
        }

        function render() {
            document.getElementById('app').innerHTML = !profile.isSetup ? renderSetup() : renderMain();
            if (profile.isSetup && activeTab === 'weight') {
                setTimeout(createWeightChart, 100);
            }
            if (profile.isSetup && activeTab === 'measurements') {
                setTimeout(createMeasurementChart, 100);
            }
        }

        function createWeightChart() {
            if (weightEntries.length < 2) return;
            
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;
            
            if (weightChart) {
                weightChart.destroy();
            }
            
            const dates = weightEntries.map(e => formatDate(e.date));
            const weights = weightEntries.map(e => e.weight);
            
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Weight (kg)',
                        data: weights,
                        borderColor: '#6b8e6b',
                        backgroundColor: 'rgba(107, 142, 107, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#6b8e6b',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + ' kg';
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createMeasurementChart() {
            if (measurements.length < 2) return;
            
            const ctx = document.getElementById('measurementChart');
            if (!ctx) return;
            
            if (measurementChart) {
                measurementChart.destroy();
            }
            
            const dates = measurements.map(m => formatDate(m.date));
            const values = measurements.map(m => m[selectedMeasurementChart] || 0);
            
            measurementChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: selectedMeasurementChart.charAt(0).toUpperCase() + selectedMeasurementChart.slice(1) + ' (' + (profile.measurementUnit || 'cm') + ')',
                        data: values,
                        borderColor: '#8fa287',
                        backgroundColor: 'rgba(143, 162, 135, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#8fa287',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + ' ' + (profile.measurementUnit || 'cm');
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function renderSetup() {
            return '<div class="setup-screen"><div class="setup-card"><div class="setup-icon">‚õëÔ∏è</div><h1 class="setup-title">Welcome!</h1><p class="setup-subtitle">Let\'s set up your Mounjaro tracker</p><div class="form-group"><label class="form-label">Your Name</label><input type="text" id="setupName" class="form-input" placeholder="Enter your name"></div><div class="form-group"><label class="form-label">Starting Weight (kg)</label><input type="number" step="0.1" id="setupWeight" class="form-input" placeholder="e.g. 73.6"></div><div class="form-group"><label class="form-label">Desired Weight (kg)</label><input type="number" step="0.1" id="setupDesired" class="form-input" placeholder="e.g. 60.0"></div><div class="form-group"><label class="form-label">Start Date</label><input type="date" id="setupDate" class="form-input"></div><div class="form-group"><label class="form-label">Measurement Unit</label><select id="setupUnit" class="form-input"><option value="cm">Centimeters (cm)</option><option value="in">Inches (in)</option></select></div><button onclick="saveSetup()" class="btn btn-primary">Start Tracking</button></div></div>';
        }

        function saveSetup() {
            const name = document.getElementById('setupName').value;
            const weight = parseFloat(document.getElementById('setupWeight').value);
            const desired = parseFloat(document.getElementById('setupDesired').value);
            const date = document.getElementById('setupDate').value;
            const unit = document.getElementById('setupUnit').value;
            if (!name || !weight || !desired || !date) { alert('Please fill in all fields'); return; }
            profile = { name, startingWeight: weight, desiredWeight: desired, startDate: date, measurementUnit: unit, isSetup: true };
            weightEntries = [{ week: 1, date, dose: 0, weight, notes: 'Starting Weight' }];
            saveData();
            render();
        }

        function renderMain() {
            const cw = weightEntries.length > 0 ? weightEntries[weightEntries.length - 1].weight : profile.startingWeight;
            const tl = (profile.startingWeight - cw).toFixed(1);
            const rem = (cw - profile.desiredWeight).toFixed(1);
            const totalToLose = profile.startingWeight - profile.desiredWeight;
            const progressPercent = totalToLose > 0 ? Math.min(((profile.startingWeight - cw) / totalToLose * 100), 100).toFixed(0) : 0;
            const unit = profile.measurementUnit || 'cm';
            
            let headerStats = '';
            if (activeTab === 'measurements' && measurements.length >= 2) {
                const calcLoss = (a) => (measurements[0][a] - measurements[measurements.length - 1][a]).toFixed(1);
                headerStats = '<div class="stats-grid" style="grid-template-columns: repeat(6, 1fr);"><div class="stat-card"><div class="stat-label">Chest Loss</div><div class="stat-value">‚àí' + calcLoss('chest') + ' ' + unit + '</div></div><div class="stat-card"><div class="stat-label">Waist Loss</div><div class="stat-value">‚àí' + calcLoss('waist') + ' ' + unit + '</div></div><div class="stat-card"><div class="stat-label">Bum Loss</div><div class="stat-value">‚àí' + calcLoss('bum') + ' ' + unit + '</div></div><div class="stat-card"><div class="stat-label">Hips Loss</div><div class="stat-value">‚àí' + calcLoss('hips') + ' ' + unit + '</div></div><div class="stat-card"><div class="stat-label">L Leg Loss</div><div class="stat-value">‚àí' + calcLoss('lLeg') + ' ' + unit + '</div></div><div class="stat-card"><div class="stat-label">R Leg Loss</div><div class="stat-value">‚àí' + calcLoss('rLeg') + ' ' + unit + '</div></div></div>';
            } else {
                headerStats = '<div class="stats-grid"><div class="stat-card"><div class="stat-label">Starting Weight</div><div class="stat-value">' + parseFloat(profile.startingWeight).toFixed(1) + ' kg</div></div><div class="stat-card"><div class="stat-label">Current Weight</div><div class="stat-value">' + parseFloat(cw).toFixed(1) + ' kg</div></div><div class="stat-card"><div class="stat-label">Total Loss</div><div class="stat-value green">-' + tl + ' kg</div></div><div class="stat-card"><div class="stat-label">To Goal</div><div class="stat-value yellow">' + (rem > 0 ? rem : '0.0') + ' kg</div><div class="progress-bar-container"><div class="progress-bar-fill" style="width: ' + progressPercent + '%">' + progressPercent + '%</div></div></div></div>';
            }
            
            return '<div class="container"><div class="header"><button onclick="showEditProfile()" class="settings-btn">‚öôÔ∏è</button><h1 class="app-title">‚õëÔ∏è My Mounjaro Tracker</h1>' + headerStats + '<div class="affirmation">"' + getRandomAffirmation() + '"</div></div><div class="tabs"><button onclick="switchTab(\'weight\')" class="tab ' + (activeTab === 'weight' ? 'active' : '') + '">üìä Weight</button><button onclick="switchTab(\'daily\')" class="tab ' + (activeTab === 'daily' ? 'active' : '') + '">üìù Daily Log</button><button onclick="switchTab(\'history\')" class="tab ' + (activeTab === 'history' ? 'active' : '') + '">üìã History</button><button onclick="switchTab(\'measurements\')" class="tab ' + (activeTab === 'measurements' ? 'active' : '') + '">üìè Measurements</button></div><div class="content">' + (activeTab === 'weight' ? renderWeightTab() : activeTab === 'daily' ? renderDailyTab() : activeTab === 'measurements' ? renderMeasurementsTab() : renderHistoryTab()) + '</div></div>';
        }

        function renderWeightTab() {
            const isEditing = editingWeightIndex !== null;
            const formData = isEditing ? weightEntries[editingWeightIndex] : {};
            const doseOptions = [0, 2.5, 5.0, 7.5, 10.0, 12.5, 15.0, 'other'];
            let doseSelect = '<select id="wDose" class="form-input" onchange="toggleCustomDose()">';
            doseOptions.forEach(d => {
                if (d === 'other') {
                    const selected = (formData.dose && ![0, 2.5, 5.0, 7.5, 10.0, 12.5, 15.0].includes(formData.dose)) ? ' selected' : '';
                    doseSelect += '<option value="other"' + selected + '>Other (manual entry)</option>';
                } else {
                    const selected = (formData.dose == d) ? ' selected' : '';
                    doseSelect += '<option value="' + d + '"' + selected + '>' + (d > 0 ? d + ' mg' : 'None') + '</option>';
                }
            });
            doseSelect += '</select>';
            
            const showCustom = isEditing && formData.dose && ![0, 2.5, 5.0, 7.5, 10.0, 12.5, 15.0].includes(formData.dose);
            
            let chartHtml = '';
            if (weightEntries.length >= 2) {
                chartHtml = '<div class="chart-container"><canvas id="weightChart"></canvas></div>';
            }
            
            return chartHtml + '<div class="content-header"><h2 class="content-title">Add New Entry</h2></div><div class="form-card"><div class="form-grid"><div><label class="form-label">Date</label><input type="date" id="wDate" value="' + (formData.date || '') + '" class="form-input" placeholder="Date"></div><div><label class="form-label">Dosage</label>' + doseSelect + '</div><div id="customDoseContainer" style="display:' + (showCustom ? 'block' : 'none') + ';" class="form-grid-full"><input type="number" step="0.1" id="wCustomDose" value="' + (showCustom ? formData.dose : '') + '" placeholder="Enter custom dosage (mg)" class="form-input"></div><input type="number" step="0.1" id="wWeight" value="' + (formData.weight || '') + '" placeholder="Weight (kg)" class="form-input"><input type="text" id="wNotes" value="' + (formData.notes || '') + '" placeholder="Notes (optional)" class="form-input"></div><div class="form-actions"><button onclick="saveWeight()" class="btn btn-primary">' + (isEditing ? 'Update Entry' : 'Save Entry') + '</button>' + (isEditing ? '<button onclick="cancelWeightForm()" class="btn btn-secondary">Cancel</button>' : '') + '</div></div>';
        }

        function renderDailyTab() {
            const todayLog = getTodayLog();
            const waterCount = todayLog ? todayLog.water : 0;
            const meals = todayLog ? todayLog.meals : '';
            const sideEffects = todayLog ? todayLog.sideEffects : [];
            
            let sideEffectsHtml = '';
            commonSideEffects.forEach(effect => {
                const active = sideEffects.includes(effect) ? ' active' : '';
                sideEffectsHtml += '<button class="side-effect-btn' + active + '" onclick="toggleSideEffect(\'' + effect + '\')">' + effect + '</button>';
            });
            
            let historyHtml = '';
            const recentLogs = [...dailyLogs].reverse().slice(0, 10);
            recentLogs.forEach(log => {
                if (log.water > 0 || log.meals || log.sideEffects.length > 0) {
                    historyHtml += '<div class="daily-log-card"><div class="daily-log-header"><span class="daily-log-date">' + formatDate(log.date) + '</span></div><div class="daily-log-content">';
                    if (log.water > 0) historyHtml += '<div>üíß Water: ' + log.water + ' glasses</div>';
                    if (log.meals) historyHtml += '<div>üçé Meals: ' + log.meals + '</div>';
                    if (log.sideEffects.length > 0) historyHtml += '<div>üò∑ Side effects: ' + log.sideEffects.join(', ') + '</div>';
                    historyHtml += '</div></div>';
                }
            });
            
            return '<div class="content-header"><h2 class="content-title">Today\'s Log</h2></div><div class="water-tracker"><div style="flex:1;"><strong style="color:#4a6b4a;">üíß Water Intake</strong><div style="font-size:0.75rem;color:#666;">Track your daily water (glasses)</div></div><div class="water-counter"><button class="water-btn" onclick="changeWater(-1)">‚àí</button><div class="water-display">' + waterCount + '</div><button class="water-btn" onclick="changeWater(1)">+</button></div></div><div class="form-card"><h3 class="form-card-title">üçé Meals & Food Notes</h3><textarea id="dailyMeals" class="form-input" style="min-height:80px;resize:vertical;" placeholder="What did you eat today? (optional)">' + meals + '</textarea><button onclick="saveMealNotes()" class="btn btn-primary" style="margin-top:0.5rem;">Save Notes</button></div><div class="form-card"><h3 class="form-card-title">üò∑ Side Effects</h3><p style="font-size:0.875rem;color:#666;margin-bottom:0.75rem;">Tap to track any side effects you\'re experiencing today</p><div class="side-effects-grid">' + sideEffectsHtml + '</div></div>' + (historyHtml ? '<div style="margin-top:2rem;"><h3 style="margin-bottom:1rem;color:#4a6b4a;">Recent Daily Logs</h3>' + historyHtml + '</div>' : '');
        }

        function changeWater(delta) {
            const todayLog = getTodayLog();
            const newWater = Math.max(0, (todayLog ? todayLog.water : 0) + delta);
            createOrUpdateTodayLog({ water: newWater });
            render();
        }

        function saveMealNotes() {
            const meals = document.getElementById('dailyMeals').value;
            createOrUpdateTodayLog({ meals: meals });
            alert('Meal notes saved!');
        }

        function toggleSideEffect(effect) {
            const todayLog = getTodayLog();
            let sideEffects = todayLog ? [...todayLog.sideEffects] : [];
            
            const index = sideEffects.indexOf(effect);
            if (index >= 0) {
                sideEffects.splice(index, 1);
            } else {
                sideEffects.push(effect);
            }
            
            createOrUpdateTodayLog({ sideEffects: sideEffects });
            render();
        }

        function toggleCustomDose() {
            const select = document.getElementById('wDose');
            const container = document.getElementById('customDoseContainer');
            if (select.value === 'other') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        function renderHistoryTab() {
            let rows = '';
            const reversedEntries = [...weightEntries].reverse();
            reversedEntries.forEach((e, i) => {
                const originalIndex = weightEntries.length - 1 - i;
                const pw = originalIndex > 0 ? weightEntries[originalIndex - 1].weight : profile.startingWeight;
                const wl = (pw - e.weight).toFixed(1);
                rows += '<tr><td style="font-weight:600;color:#4a6b4a;">' + formatDate(e.date) + '</td><td><span class="badge badge-purple">' + (e.dose > 0 ? e.dose + 'mg' : '‚Äî') + '</span></td><td class="weight-large">' + parseFloat(e.weight).toFixed(1) + '</td><td class="weight-large">' + (originalIndex > 0 ? '‚àí' + wl : '‚Äî') + '</td><td style="color:#6b7280;font-style:italic;font-size:0.875rem;">' + (e.notes || '') + '</td><td><div class="actions"><button onclick="editWeight(' + originalIndex + ')" class="btn-icon btn-edit">‚úèÔ∏è</button>' + (originalIndex !== 0 ? '<button onclick="deleteWeight(' + originalIndex + ')" class="btn-icon btn-delete">üóëÔ∏è</button>' : '') + '</div></td></tr>';
            });
            
            return '<div class="content-header"><h2 class="content-title">Weight History</h2><button onclick="exportToCSV()" class="btn-export">üì• Export CSV</button></div>' + (weightEntries.length > 0 ? '<div style="overflow-x:auto;"><table><thead><tr><th>Date</th><th>Dose</th><th>Weight</th><th>Weekly Loss</th><th>Notes</th><th class="center">Actions</th></tr></thead><tbody>' + rows + '</tbody></table></div>' : '<div class="empty-state"><p style="font-size:1.125rem;margin-bottom:0.5rem;">No entries yet</p><p style="font-size:0.875rem;">Add your first entry in the Weight Tracker tab</p></div>');
        }

        function renderMeasurementsTab() {
            const unit = profile.measurementUnit || 'cm';
            
            let chartHtml = '';
            if (measurements.length >= 2) {
                let chartButtons = '';
                ['chest', 'waist', 'bum', 'hips', 'lLeg', 'rLeg'].forEach(m => {
                    const active = selectedMeasurementChart === m ? ' active' : '';
                    const label = m === 'lLeg' ? 'L Leg' : m === 'rLeg' ? 'R Leg' : m.charAt(0).toUpperCase() + m.slice(1);
                    chartButtons += '<button class="chart-type-btn' + active + '" onclick="changeMeasurementChart(\'' + m + '\')">' + label + '</button>';
                });
                chartHtml = '<div class="chart-container"><div class="chart-type-selector">' + chartButtons + '</div><canvas id="measurementChart"></canvas></div>';
            }
            
            if (measurements.length === 0) return chartHtml + '<div class="content-header"><h2 class="content-title">Body Measurements (' + unit + ')</h2><div style="display:flex;gap:0.5rem;"><button onclick="showManageCustomMeasurements()" class="btn-export">‚öôÔ∏è Custom Fields</button><button onclick="showAddMeasurement()" class="btn-add">‚ûï Add Measurement</button></div></div><div id="measurementForm"></div><div class="empty-state"><p style="font-size:1.125rem;margin-bottom:0.5rem;">No measurements yet</p><p style="font-size:0.875rem;">Click "Add Measurement" to start tracking</p></div>';
            
            let rows = '';
            const reversedMeasurements = [...measurements].reverse();
            reversedMeasurements.forEach((m, i) => {
                const originalIndex = measurements.length - 1 - i;
                let customCols = '';
                if (m.custom && Array.isArray(m.custom)) {
                    m.custom.forEach(c => {
                        customCols += '<td style="text-align:center;font-weight:600;">' + (c.value || '‚Äî') + '</td>';
                    });
                }
                rows += '<tr><td style="font-weight:600;color:#4a6b4a;">' + formatDate(m.date) + '</td><td style="text-align:center;font-weight:600;">' + m.chest + '</td><td style="text-align:center;font-weight:600;">' + m.waist + '</td><td style="text-align:center;font-weight:600;">' + m.bum + '</td><td style="text-align:center;font-weight:600;">' + m.hips + '</td><td style="text-align:center;font-weight:600;">' + m.lLeg + '</td><td style="text-align:center;font-weight:600;">' + m.rLeg + '</td>' + customCols + '<td><div class="actions"><button onclick="editMeasurement(' + originalIndex + ')" class="btn-icon btn-edit">‚úèÔ∏è</button><button onclick="deleteMeasurement(' + originalIndex + ')" class="btn-icon btn-delete">üóëÔ∏è</button></div></td></tr>';
            });
            
            let customHeaders = '';
            if (customMeasurements.length > 0) {
                customMeasurements.forEach(cm => {
                    customHeaders += '<th class="center">' + cm.name + '</th>';
                });
            }
            
            return chartHtml + '<div class="content-header"><h2 class="content-title">Body Measurements (' + unit + ')</h2><div style="display:flex;gap:0.5rem;"><button onclick="showManageCustomMeasurements()" class="btn-export">‚öôÔ∏è Custom Fields</button><button onclick="showAddMeasurement()" class="btn-add">‚ûï Add Measurement</button></div></div><div id="measurementForm"></div><div style="overflow-x:auto;"><table><thead><tr><th>Date</th><th class="center">Chest</th><th class="center">Waist</th><th class="center">Bum</th><th class="center">Hips</th><th class="center">L Leg</th><th class="center">R Leg</th>' + customHeaders + '<th class="center">Actions</th></tr></thead><tbody>' + rows + '</tbody></table></div>';
        }

        function changeMeasurementChart(type) {
            selectedMeasurementChart = type;
            render();
        }

        function switchTab(tab) { activeTab = tab; editingWeightIndex = null; editingMeasurementIndex = null; render(); }

        function saveWeight() {
            const date = document.getElementById('wDate').value;
            const doseSelect = document.getElementById('wDose').value;
            let dose;
            if (doseSelect === 'other') {
                dose = parseFloat(document.getElementById('wCustomDose').value);
                if (!dose || dose <= 0) { alert('Please enter a valid custom dosage'); return; }
            } else {
                dose = parseFloat(doseSelect) || 0;
            }
            const weight = parseFloat(document.getElementById('wWeight').value);
            const notes = document.getElementById('wNotes').value;
            if (!date || !weight) { alert('Please enter date and weight'); return; }
            if (editingWeightIndex !== null) {
                weightEntries[editingWeightIndex] = { ...weightEntries[editingWeightIndex], date, dose, weight, notes };
                editingWeightIndex = null;
            } else {
                const lw = weightEntries.length > 0 ? weightEntries[weightEntries.length - 1].week : 0;
                weightEntries.push({ week: lw + 1, date, dose, weight, notes });
                document.getElementById('wDate').value = '';
                document.getElementById('wDose').value = '0';
                document.getElementById('wWeight').value = '';
                document.getElementById('wNotes').value = '';
                if (document.getElementById('customDoseContainer')) {
                    document.getElementById('customDoseContainer').style.display = 'none';
                }
            }
            saveData(); 
            render();
        }

        function editWeight(i) { editingWeightIndex = i; activeTab = 'weight'; render(); }
        function deleteWeight(i) { if (confirm('Delete this entry?')) { weightEntries.splice(i, 1); saveData(); render(); } }
        function cancelWeightForm() { editingWeightIndex = null; render(); }

        function showAddMeasurement() { editingMeasurementIndex = null; showMeasurementForm(); }

        function showMeasurementForm(d = {}) {
            let customFields = '';
            if (customMeasurements.length > 0) {
                customMeasurements.forEach((cm, idx) => {
                    const val = d.custom && d.custom[idx] ? d.custom[idx].value : '';
                    customFields += '<input type="number" step="0.1" id="mCustom' + idx + '" value="' + val + '" placeholder="' + cm.name + ' (' + (profile.measurementUnit || 'cm') + ')" class="form-input">';
                });
            }
            
            document.getElementById('measurementForm').innerHTML = '<div class="form-card"><h3 class="form-card-title">' + (editingMeasurementIndex !== null ? 'Edit Measurement' : 'Add New Measurement') + '</h3><div class="form-grid"><input type="date" id="mDate" value="' + (d.date || '') + '" class="form-input form-grid-full"><input type="number" step="0.1" id="mChest" value="' + (d.chest || '') + '" placeholder="Chest (cm)" class="form-input"><input type="number" step="0.1" id="mWaist" value="' + (d.waist || '') + '" placeholder="Waist (cm)" class="form-input"><input type="number" step="0.1" id="mBum" value="' + (d.bum || '') + '" placeholder="Bum (cm)" class="form-input"><input type="number" step="0.1" id="mHips" value="' + (d.hips || '') + '" placeholder="Hips (cm)" class="form-input"><input type="number" step="0.1" id="mLLeg" value="' + (d.lLeg || '') + '" placeholder="L Leg (cm)" class="form-input"><input type="number" step="0.1" id="mRLeg" value="' + (d.rLeg || '') + '" placeholder="R Leg (cm)" class="form-input">' + customFields + '</div><div class="form-actions"><button onclick="saveMeasurement()" class="btn btn-primary">' + (editingMeasurementIndex !== null ? 'Update' : 'Save') + '</button><button onclick="cancelMeasurementForm()" class="btn btn-secondary">Cancel</button></div></div>';
        }

        function saveMeasurement() {
            const date = document.getElementById('mDate').value;
            const chest = parseFloat(document.getElementById('mChest').value) || 0;
            const waist = parseFloat(document.getElementById('mWaist').value) || 0;
            const bum = parseFloat(document.getElementById('mBum').value) || 0;
            const hips = parseFloat(document.getElementById('mHips').value) || 0;
            const lLeg = parseFloat(document.getElementById('mLLeg').value) || 0;
            const rLeg = parseFloat(document.getElementById('mRLeg').value) || 0;
            
            const custom = [];
            customMeasurements.forEach((cm, idx) => {
                const val = parseFloat(document.getElementById('mCustom' + idx).value) || 0;
                custom.push({ name: cm.name, value: val });
            });
            
            if (!date) { alert('Please enter a date'); return; }
            if (editingMeasurementIndex !== null) {
                measurements[editingMeasurementIndex] = { date, chest, waist, bum, hips, lLeg, rLeg, custom };
            } else {
                measurements.push({ date, chest, waist, bum, hips, lLeg, rLeg, custom });
            }
            saveData(); editingMeasurementIndex = null; render();
        }

        function editMeasurement(i) { editingMeasurementIndex = i; render(); showMeasurementForm(measurements[i]); }
        function deleteMeasurement(i) { if (confirm('Delete this measurement?')) { measurements.splice(i, 1); saveData(); render(); } }
        function cancelMeasurementForm() { editingMeasurementIndex = null; render(); }

        function showManageCustomMeasurements() {
            const o = document.createElement('div');
            o.className = 'overlay';
            let customFieldsHtml = '';
            customMeasurements.forEach((cm, idx) => {
                customFieldsHtml += '<div class="form-group" style="display:flex;gap:0.5rem;align-items:flex-end;"><div style="flex:1;"><label class="form-label">Custom Field ' + (idx + 1) + '</label><input type="text" id="customField' + idx + '" value="' + cm.name + '" class="form-input" placeholder="e.g., Arm, Neck"></div><button onclick="removeCustomField(' + idx + ')" class="btn-icon btn-delete" style="margin-bottom:0.1rem;">üóëÔ∏è</button></div>';
            });
            
            o.innerHTML = '<div class="modal"><h2 class="modal-title">Manage Custom Measurements</h2>' + customFieldsHtml + '<button onclick="addCustomField()" class="btn btn-secondary" style="margin-top:1rem;width:100%;">‚ûï Add Custom Field</button><div class="modal-actions"><button onclick="saveCustomMeasurements()" class="btn btn-primary">Save</button><button onclick="closeCustomMeasurements()" class="btn btn-secondary">Cancel</button></div></div>';
            o.onclick = (e) => { if (e.target === o) closeCustomMeasurements(); };
            document.body.appendChild(o);
            window.customMeasurementsOverlay = o;
        }

        function addCustomField() {
            customMeasurements.push({ name: '' });
            showManageCustomMeasurements();
        }

        function removeCustomField(idx) {
            customMeasurements.splice(idx, 1);
            showManageCustomMeasurements();
        }

        function saveCustomMeasurements() {
            customMeasurements = customMeasurements.map((cm, idx) => {
                const input = document.getElementById('customField' + idx);
                return { name: input ? input.value : cm.name };
            }).filter(cm => cm.name.trim() !== '');
            
            saveData();
            closeCustomMeasurements();
            render();
        }

        function closeCustomMeasurements() {
            if (window.customMeasurementsOverlay) window.customMeasurementsOverlay.remove();
        }

        function showEditProfile() {
            const o = document.createElement('div');
            o.className = 'overlay';
            o.innerHTML = '<div class="modal"><h2 class="modal-title">Edit Profile</h2><div class="form-group"><label class="form-label">Name</label><input type="text" id="editName" value="' + profile.name + '" class="form-input"></div><div class="form-group"><label class="form-label">Starting Weight (kg)</label><input type="number" step="0.1" id="editWeight" value="' + profile.startingWeight + '" class="form-input"></div><div class="form-group"><label class="form-label">Desired Weight (kg)</label><input type="number" step="0.1" id="editDesired" value="' + profile.desiredWeight + '" class="form-input"></div><div class="form-group"><label class="form-label">Start Date</label><input type="date" id="editDate" value="' + profile.startDate + '" class="form-input"></div><div class="form-group"><label class="form-label">Measurement Unit</label><select id="editUnit" class="form-input"><option value="cm"' + (profile.measurementUnit === 'cm' ? ' selected' : '') + '>Centimeters (cm)</option><option value="in"' + (profile.measurementUnit === 'in' ? ' selected' : '') + '>Inches (in)</option></select></div><div class="modal-actions"><button onclick="updateProfile()" class="btn btn-primary">Save</button><button onclick="closeEditProfile()" class="btn btn-secondary">Cancel</button></div><button onclick="exportData()" class="btn btn-export" style="width:100%;margin-top:1rem;">üì• Export All Data (Backup)</button><button onclick="resetAll()" class="btn btn-danger">Reset All Data</button></div>';
            o.onclick = (e) => { if (e.target === o) closeEditProfile(); };
            document.body.appendChild(o);
            window.editProfileOverlay = o;
        }

        function updateProfile() {
            profile.name = document.getElementById('editName').value;
            profile.startingWeight = parseFloat(document.getElementById('editWeight').value);
            profile.desiredWeight = parseFloat(document.getElementById('editDesired').value);
            profile.startDate = document.getElementById('editDate').value;
            profile.measurementUnit = document.getElementById('editUnit').value;
            if (weightEntries[0]) { weightEntries[0].date = profile.startDate; weightEntries[0].weight = profile.startingWeight; }
            saveData(); closeEditProfile(); render();
        }

        function closeEditProfile() { if (window.editProfileOverlay) window.editProfileOverlay.remove(); }
        function resetAll() { if (confirm('Reset ALL data? This cannot be undone!')) { localStorage.clear(); location.reload(); } }

        // Migrate old 'bust' data to 'chest' if needed
        measurements.forEach(m => {
            if (m.bust !== undefined && m.chest === undefined) {
                m.chest = m.bust;
                delete m.bust;
            }
        });
        saveData();

        render();
    </script>
</body>
</html>